# AI-USDT-Futures-Bot

基于大语言模型的加密货币 USDT 永续合约自动交易系统。系统通过多维度技术分析、AI 决策引擎、记忆学习机制和多层风控体系，实现全自动化的合约交易。

---

## 目录

- [系统架构](#系统架构)
- [核心模块](#核心模块)
- [交易决策流程](#交易决策流程)
- [技术指标体系](#技术指标体系)
- [AI 决策引擎](#ai-决策引擎)
- [风险管理](#风险管理)
- [记忆与学习系统](#记忆与学习系统)
- [仓位管理策略](#仓位管理策略)
- [实时监控面板](#实时监控面板)
- [数据库设计](#数据库设计)
- [环境配置](#环境配置)
- [快速开始](#快速开始)
- [优化方向](#优化方向)

---

## 系统架构

```
┌──────────────────────────────────────────────────────────────────┐
│                         交易主循环 (60s)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────────┐  │
│  │ 熔断检查  │→│ 账户状态  │→│ 交易对筛选│→│ 并行处理(3路)   │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                                    ↓
┌──────────────────────────────────────────────────────────────────┐
│                      单币种处理流程                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────────┐  │
│  │ 行情快照  │→│ 技术分析  │→│ AI 决策   │→│ 风控 → 执行     │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                                    ↓
┌──────────────────────────────────────────────────────────────────┐
│                        支撑系统                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────────┐  │
│  │ SQLite   │  │ 记忆系统  │  │ 策略优化  │  │ WebSocket 面板 │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

### 项目结构

```
src/
├── index.ts                  # 入口：Express + WebSocket 服务启动
├── config.ts                 # 环境变量与风控参数配置
├── core/
│   ├── loop.ts              # 交易主循环（60s 间隔，3 路并发）
│   ├── session.ts           # AI 交易会话编排（指标→情绪→记忆→AI调用）
│   ├── decision.ts          # 决策 Schema 定义与 JSON 解析
│   └── pair-selector.ts     # 交易对选择（6 主流币 + 持仓币）
├── exchange/
│   ├── client.ts            # CCXT 客户端（测试网/主网切换，代理支持）
│   ├── executor.ts          # 订单执行（LONG/SHORT/CLOSE/ADD/REDUCE/ADJUST）
│   ├── market-data.ts       # 行情数据（Ticker/K线/深度/资金费率）
│   └── account.ts           # 账户余额与持仓查询
├── ai/
│   ├── provider.ts          # AI 提供商接口定义
│   ├── router.ts            # 多提供商路由与故障转移
│   └── providers/           # DeepSeek / OpenAI / Anthropic / Gemini / Qwen
├── analysis/
│   └── indicators.ts        # 20+ 技术指标计算与格式化
├── memory/
│   ├── memory-store.ts      # 记忆持久化（存储/检索/衰减）
│   └── memory-context.ts    # 市场环境检测与记忆注入
├── optimization/
│   └── strategy-review.ts   # AI 驱动的策略自审（每50笔或每日）
├── risk/
│   ├── circuit-breaker.ts   # 熔断器（连亏/API失败/日亏损限制）
│   └── hard-limits.ts       # 硬性风控（仓位/杠杆/敞口上限）
├── persistence/
│   ├── db.ts                # SQLite 初始化（WAL 模式）
│   └── models/              # trade / decision / position / snapshot / daily_pnl
├── dashboard/
│   ├── routes.ts            # REST API（状态/交易/持仓/熔断控制）
│   ├── websocket.ts         # WebSocket 实时推送（3s 间隔）
│   └── public/              # 前端（暗色主题，权益曲线，虚拟滚动）
└── utils/
    ├── logger.ts            # Winston 日志
    ├── retry.ts             # 指数退避重试
    └── proxy.ts             # HTTP/SOCKS 代理
```

---

## 核心模块

### 交易主循环 (`core/loop.ts`)

主循环每 60 秒执行一次 `tick()`，流程如下：

1. **熔断检查** — 如果熔断器激活，跳过本轮
2. **获取账户状态** — 余额、持仓、未实现盈亏
3. **构建交易对列表**
   - 有持仓的币种：每轮都分析（盯仓）
   - 无持仓的主流币：每 5 分钟扫描一次（找机会）
4. **账户快照** — 记录余额和持仓到数据库
5. **日盈亏追踪** — 计算当日亏损百分比，触发日亏损熔断
6. **记忆衰减** — 每日对旧记忆执行 5% 衰减
7. **策略审查** — 每 50 笔平仓或每日触发 AI 策略自审
8. **并行处理** — 最多 3 个币种同时处理

### AI 交易会话 (`core/session.ts`)

每个币种的处理核心，编排完整的分析→决策流程：

1. 计算 4 个时间周期（1m/5m/15m/1h）的技术指标
2. 分析订单簿深度（买卖力量、挂单墙、微观压力）
3. 计算市场情绪分数（-100 到 +100）
4. 检测市场环境（5 种 regime）
5. 构建记忆上下文（历史教训、币种胜率）
6. 调用 AI 生成交易决策
7. 解析 JSON 格式的决策结果

---

## 交易决策流程

```
行情快照 ──→ 技术指标(4周期) ──→ 订单簿分析 ──→ 情绪评分
                                                    ↓
记忆上下文 ←── 市场环境检测 ←── 情绪 + 指标 + 深度
    ↓
AI 大模型 ──→ JSON 决策 ──→ 风控检查 ──→ 订单执行
                                          ↓
                              持仓更新 → 记忆存储 → WebSocket 推送
```

### 决策类型

| 动作 | 说明 | 触发场景 |
|------|------|----------|
| `LONG` | 开多仓 | 多周期共振看涨，无持仓 |
| `SHORT` | 开空仓 | 多周期共振看跌，无持仓 |
| `CLOSE` | 平仓 | 止盈/止损/趋势反转 |
| `ADD` | 加仓（盈利滚仓） | 持仓盈利 >2%，趋势延续确认 |
| `REDUCE` | 减仓（做T降本） | 持仓亏损但出现微观反弹信号 |
| `ADJUST` | 调整止盈止损 | 需要移动止损保护利润 |
| `HOLD` | 观望 | 无明确信号 |

### 决策优先级

- 有仓位时：`CLOSE > REDUCE > ADD > ADJUST > HOLD`
- 无仓位时：`LONG/SHORT > HOLD`

---

## 技术指标体系

系统在 4 个时间周期（1m/5m/15m/1h）上计算 20+ 技术指标：

### 趋势类
- EMA7 / EMA21 / EMA50（多头/空头排列判断）
- SMA20
- Parabolic SAR（趋势方向信号）

### 动量类
- RSI14（超买 >70 / 超卖 <30）
- MACD（金叉/死叉信号）
- Stochastic K/D
- Williams %R
- CCI（商品通道指数）

### 波动率
- Bollinger Bands（上轨/中轨/下轨/带宽/%B）
- ATR14（平均真实波幅，含价格百分比）

### 趋势强度
- ADX（+DI / -DI，>25 为强趋势）

### 成交量
- OBV（能量潮）
- MFI（资金流量指数）
- 成交量比率（近 5 根 / 前 20 根均量）
- VWAP（成交量加权平均价）

### 高级指标
- Ichimoku Cloud（一目均衡表：转换线/基准线/先行带 A/B）

### 订单簿分析
- 买卖总量与比率
- 买卖挂单墙检测
- 价差百分比
- 微观压力（前 3 档）

### 市场情绪
- 资金费率信号（贪婪/恐惧）
- 成交量动量
- 价格在布林带中的位置
- 综合偏差分数（-100 到 +100）

---

## AI 决策引擎

### 多提供商支持

| 提供商 | 默认模型 | 说明 |
|--------|----------|------|
| DeepSeek | deepseek-chat | 默认首选，性价比高 |
| OpenAI | gpt-4o | 备选 |
| Anthropic | claude-sonnet-4 | 备选 |
| Gemini | gemini-2.0-flash | 备选 |
| Qwen（通义千问） | qwen-plus | 备选 |

### 路由与故障转移

- 优先使用配置的首选提供商
- 首选失败时，按失败次数排序尝试其他提供商
- 每个提供商独立追踪失败计数
- 单次会话最多重试 1 次
- 所有提供商均失败时抛出异常

### AI 人设

系统提示词将 AI 设定为「10 年以上实战经验的顶级加密货币合约交易大师」，具备：
- 5 种市场环境的识别与对应策略
- 盈利滚仓（ADD）和亏损做T（REDUCE）的仓位管理能力
- 基于 ATR 的动态止损策略
- 简化 Kelly 公式的仓位计算
- 10 条核心交易原则

---

## 风险管理

### 熔断器 (`risk/circuit-breaker.ts`)

| 触发条件 | 阈值 | 冷却时间 |
|----------|------|----------|
| 连续亏损 | 3 次 | 1 小时 |
| 连续 API 失败 | 5 次 | 1 小时 |
| 日亏损超限 | 5% | 1 小时 |
| 手动紧急停止 | — | 手动重置 |

熔断器还追踪连胜/连败状态，注入 AI 提示词中影响仓位大小决策。

### 硬性风控 (`risk/hard-limits.ts`)

| 参数 | 限制 |
|------|------|
| 单仓位占比 | ≤ 10% 总余额 |
| 总敞口 | ≤ 30% 总余额 |
| 最大杠杆 | ≤ 10x |
| 最大并发持仓 | ≤ 5 个 |
| 加仓次数 | ≤ 2 次，总量 ≤ 2.5x 初始 |
| 减仓次数 | ≤ 3 次 |
| 加仓条件 | 盈利 > 1.5% |

### 风控执行顺序

```
AI 决策 → 硬性风控检查 → 通过 → 执行订单
                        → 未通过 → 记录原因，跳过执行
```

---

## 记忆与学习系统

### 记忆存储 (`memory/memory-store.ts`)

每笔平仓交易自动生成记忆：
- 交易结果（盈/亏、百分比、原因）
- 市场环境标签
- 相关性评分（大额盈亏权重更高）

### 记忆检索

AI 决策前注入相关记忆：
- 当前币种的历史统计（胜率、盈亏比）
- 相同市场环境下的历史教训
- 近期失败教训（高优先级）
- 全币种胜率排名

### 记忆衰减

每日对超过 3 天的记忆执行 5% 衰减，确保近期经验权重更高。

### 策略自审 (`optimization/strategy-review.ts`)

触发条件：每 50 笔平仓交易或每日（≥10 笔时）

流程：
1. 分析交易历史（按币种、环境、操作类型）
2. 计算整体统计（胜率、平均盈亏、盈亏比）
3. 调用 AI 生成改进建议
4. 将建议存入记忆系统，影响后续决策

---

## 仓位管理策略

### 盈利滚仓（ADD）

```
条件: 持仓盈利 > 2% + 趋势延续确认
      (EMA排列 + MACD同向 + 成交量配合)
操作: 加仓当前仓位的 30-50%
限制: 最多加仓 2 次，总量 ≤ 2.5x 初始
后续: 上移止损到新均价附近保护利润
```

### 亏损做T（REDUCE）

```
条件: 持仓亏损 + 微观反弹信号
      (RSI超卖反弹 / 订单簿买方增强 / 短周期MACD金叉)
操作: 减仓 30-50%，降低持仓成本
限制: 最多做T 3 次
目的: 等回落后再加回，降低均价
```

### 动态止损

```
初始: 基于 ATR（1.5-2 倍 ATR）
追踪: 每盈利 1 个 ATR，上移止损 0.5 个 ATR
加仓后: 止损调整到新均价 - 1 倍 ATR
```

### 仓位大小（简化 Kelly）

```
基础仓位 = 胜率 × 2 - 1（Kelly 比例的一半）
连胜: 最多 1.5 倍基础仓位
连败: 最少 0.5 倍基础仓位
```

---

## 实时监控面板

### REST API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/status` | GET | 运行状态、余额、持仓、熔断状态 |
| `/api/trades` | GET | 最近交易记录 |
| `/api/decisions` | GET | AI 决策历史 |
| `/api/positions/open` | GET | 当前持仓 |
| `/api/positions/history` | GET | 历史持仓 |
| `/api/daily-pnl` | GET | 每日盈亏 |
| `/api/snapshots` | GET | 账户快照 |
| `/api/tickers` | GET | 主流币行情 |
| `/api/circuit` | GET | 熔断器状态 |
| `/api/circuit/reset` | POST | 重置熔断器 |
| `/api/emergency-stop` | POST | 紧急停止 |
| `/api/start` | POST | 启动交易循环 |
| `/api/stop` | POST | 停止交易循环 |

### WebSocket 推送（3s 间隔）

- `tickers` — 主流币行情更新
- `account` — 余额与持仓
- `decision` — AI 决策
- `trade` — 成交记录
- `circuit` — 熔断器状态
- `pairs` — 活跃交易对

### 前端功能

- 暗色主题界面
- 实时行情 Ticker 栏
- 账户统计卡片（总余额/可用/日盈亏/未实现盈亏）
- 权益曲线图表（Chart.js）
- 当前持仓 / 最近交易 / 历史持仓 Tab 切换
- AI 分析历史侧边栏（虚拟滚动，最多 500 条）
- 一键启停 / 紧急停止 / 熔断重置

---

## 数据库设计

SQLite（WAL 模式），共 9 张表：

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `trades` | 所有执行的交易 | symbol, action, side, amount, price, leverage, pnl |
| `decisions` | 所有 AI 决策 | action, confidence, reasoning, risk_passed, indicators_json |
| `positions` | 仓位生命周期 | side, amount, entry/exit_price, pnl, add_count, reduce_count |
| `position_operations` | 仓位操作明细 | operation(OPEN/ADD/REDUCE/CLOSE), pnl_realized, avg_entry_after |
| `snapshots` | 账户快照 | total_balance, available_balance, unrealized_pnl |
| `daily_pnl` | 每日盈亏 | starting_balance, ending_balance, realized_pnl, trade_count |
| `strategy_memory` | 策略记忆 | memory_type, content, market_condition, outcome, relevance_score |
| `symbol_stats` | 币种统计 | total_trades, wins, losses, win_rate, profit_factor |
| `strategy_reviews` | 策略审查 | insights_json, recommendations_json, win_rate |

---

## 环境配置

创建 `.env` 文件：

```env
# 模式切换
TESTNET_ONLY=true

# Binance 测试网
BINANCE_API_KEY=your_testnet_api_key
BINANCE_SECRET_KEY=your_testnet_secret_key

# Binance 主网（TESTNET_ONLY=false 时使用）
BINANCE_LIVE_API_KEY=your_live_api_key
BINANCE_LIVE_SECRET_KEY=your_live_secret_key

# AI 提供商（选择一个作为主力）
AI_PROVIDER=deepseek
DEEPSEEK_API_KEY=your_deepseek_key
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 备选 AI 提供商（可选，用于故障转移）
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key
GEMINI_API_KEY=your_gemini_key
QWEN_API_KEY=your_qwen_key

# 服务端口
PORT=3000

# 代理（可选）
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

---

## 快速开始

```bash
# 1. 安装依赖
npm install

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 填入 API Key

# 3. 开发模式运行
npm run dev

# 4. 或编译后运行
npm run build
npm start

# 5. 访问监控面板
# 浏览器打开 http://localhost:3000

# 6. 重置数据库（如需要）
npm run reset:db
```

---

## 优化方向

### 1. 动态交易对选择

当前系统固定 6 个主流币（BTC/ETH/SOL/BNB/XRP/DOGE）。可以改为：
- 基于成交量、波动率、资金费率等指标动态筛选全市场 USDT 永续合约
- 引入「热度评分」机制，自动发现高波动高流动性的交易机会
- 根据记忆系统中各币种的历史胜率，动态调整关注列表

### 2. 多时间框架权重优化

当前 4 个时间周期（1m/5m/15m/1h）的指标平等地传给 AI，没有显式权重。可以：
- 根据市场环境动态调整各周期权重（趋势市重视 1h，震荡市重视 5m）
- 增加更长周期（4h/1d）用于判断大趋势方向
- 实现多周期共振评分系统，量化各周期信号的一致性

### 3. AI Prompt 优化与结构化

当前 prompt 将所有原始 K 线数据（每周期 100 根）直接传给 AI，token 消耗大且信息密度低。可以：
- 用预处理摘要替代原始 K 线（如「15m 级别：连续 5 根阳线，放量突破 EMA21」）
- 将技术指标转化为结构化信号（如 `{signal: "bullish", strength: 0.8, source: "MACD金叉+RSI回升"}`）
- 减少 token 消耗的同时提高 AI 决策质量

### 4. 回测系统

当前没有回测能力，无法验证策略有效性。建议：
- 实现历史 K 线数据的本地缓存与回放
- 模拟交易引擎（撮合、滑点、手续费）
- 生成回测报告（夏普比率、最大回撤、盈亏比、胜率曲线）
- 支持参数扫描和策略对比

### 5. 订单执行优化

当前以市价单为主，缺少精细化执行策略：
- 实现 TWAP/VWAP 分批建仓，减少大单冲击
- 限价单 + 超时自动转市价的混合策略
- 滑点监控与异常报警
- 订单状态追踪（部分成交处理）

### 6. 风控体系增强

当前风控较为基础，可以增加：
- 相关性风控：避免同时持有高相关性币种（如 BTC 和 ETH 同向）
- 波动率自适应仓位：VIX 类指标高时自动缩小仓位
- 黑天鹅保护：极端行情（5 分钟跌幅 >5%）自动全平
- 资金曲线风控：权益曲线跌破 N 日均线时降低仓位
- 熔断器分级：轻度（缩小仓位）→ 中度（只平不开）→ 重度（全部暂停）

### 7. 数据源扩展

当前仅依赖 Binance 交易所数据：
- 接入链上数据（大户转账、交易所净流入/流出）
- 接入社交媒体情绪（Twitter/Reddit 加密货币情绪指数）
- 接入宏观数据（美元指数、美债收益率、恐贪指数）
- 多交易所价差监控（套利信号）

### 8. 记忆系统升级

当前记忆是简单的文本存储 + 相关性评分：
- 引入向量数据库（如 ChromaDB），实现语义检索
- 记忆分类更精细：模式记忆（特定形态的成功率）、时间记忆（特定时段的表现）
- 记忆权重动态调整：近期记忆权重更高，但经典教训不衰减
- 跨币种记忆迁移：BTC 的经验可以部分应用到 ETH

### 9. 多交易所支持

当前仅支持 Binance：
- 扩展到 OKX、Bybit 等主流交易所
- 实现跨交易所套利策略
- 统一账户管理和风控

### 10. 监控与告警

当前仅有 WebSocket 面板和日志：
- 接入 Telegram/微信 Bot 推送关键事件（开仓/平仓/熔断/异常）
- 实现性能监控（AI 响应延迟、API 调用成功率、内存使用）
- 异常检测告警（连续 HOLD、长时间无交易、余额异常变动）

### 11. 安全加固

- API Key 加密存储（而非明文 .env）
- Dashboard 添加认证（当前无鉴权，任何人可访问控制接口）
- 限制 API 调用频率，防止误操作
- 操作审计日志

### 12. 性能优化

- 技术指标计算缓存（相同 K 线数据不重复计算）
- 数据库查询优化（添加索引、批量写入）
- WebSocket 推送按需订阅（而非全量广播）
- AI 调用并发控制与队列管理

---

## 技术栈

| 组件 | 技术 |
|------|------|
| 运行时 | Node.js + TypeScript |
| 交易所 | CCXT (Binance Futures) |
| 数据库 | SQLite (better-sqlite3, WAL) |
| Web 服务 | Express |
| 实时通信 | WebSocket (ws) |
| 技术分析 | technicalindicators |
| 图表 | Chart.js |
| 日志 | Winston |
| 校验 | Zod |
| AI | DeepSeek / OpenAI / Anthropic / Gemini / Qwen |

---

## 免责声明

本项目仅供学习和研究使用。加密货币合约交易具有极高风险，可能导致全部本金损失。请在充分了解风险的前提下，使用测试网进行验证。作者不对任何交易损失承担责任。
